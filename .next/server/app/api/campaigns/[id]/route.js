(()=>{var e={};e.id=461,e.ids=[461],e.modules={517:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4300:e=>{"use strict";e.exports=require("buffer")},2081:e=>{"use strict";e.exports=require("child_process")},6113:e=>{"use strict";e.exports=require("crypto")},2361:e=>{"use strict";e.exports=require("events")},7147:e=>{"use strict";e.exports=require("fs")},3292:e=>{"use strict";e.exports=require("fs/promises")},3685:e=>{"use strict";e.exports=require("http")},5158:e=>{"use strict";e.exports=require("http2")},5687:e=>{"use strict";e.exports=require("https")},1808:e=>{"use strict";e.exports=require("net")},4492:e=>{"use strict";e.exports=require("node:stream")},2037:e=>{"use strict";e.exports=require("os")},1017:e=>{"use strict";e.exports=require("path")},7282:e=>{"use strict";e.exports=require("process")},5477:e=>{"use strict";e.exports=require("punycode")},2781:e=>{"use strict";e.exports=require("stream")},4404:e=>{"use strict";e.exports=require("tls")},7310:e=>{"use strict";e.exports=require("url")},3837:e=>{"use strict";e.exports=require("util")},9796:e=>{"use strict";e.exports=require("zlib")},8359:()=>{},948:()=>{},7424:(e,r,t)=>{"use strict";t.r(r),t.d(r,{headerHooks:()=>y,originalPathname:()=>w,patchFetch:()=>x,requestAsyncStorage:()=>_,routeModule:()=>f,serverHooks:()=>q,staticGenerationAsyncStorage:()=>E,staticGenerationBailout:()=>v});var s={};t.r(s),t.d(s,{DELETE:()=>g,GET:()=>d,PATCH:()=>m});var a=t(5419),i=t(9108),n=t(9678),o=t(8070),c=t(1664),u=t(3658),l=t(5256);let p=l.Ry({name:l.Z_().min(1).max(255).optional(),subject:l.Z_().min(1).max(255).optional(),content:l.Z_().min(1).optional(),template_id:l.Km(["newsletter","promotional","welcome"]).optional(),status:l.Km(["draft","sending","sent","failed"]).optional()});async function d(e,{params:r}){try{let{id:e}=r;if(!e)return o.Z.json({error:"Campaign ID is required"},{status:400});let t=(0,c.l)(),{data:s,error:a}=await t.from("campaigns").select(`
        *,
        email_lists (
          id,
          name,
          subscriber_count
        )
      `).eq("id",e).single();if(a||!s)return o.Z.json({error:"Campaign not found"},{status:404});let i=await (0,u.vr)(e);return o.Z.json({campaign:{...s,analytics:i}})}catch(e){return console.error("Error in GET /api/campaigns/[id]:",e),o.Z.json({error:"Internal server error"},{status:500})}}async function m(e,{params:r}){try{let{id:t}=r,s=await e.json();if(!t)return o.Z.json({error:"Campaign ID is required"},{status:400});let a=p.safeParse(s);if(!a.success)return o.Z.json({error:"Invalid request data",details:a.error.errors},{status:400});let i=a.data,n=(0,c.l)(),{data:u,error:l}=await n.from("campaigns").select("id, status").eq("id",t).single();if(l||!u)return o.Z.json({error:"Campaign not found"},{status:404});if("sent"===u.status&&Object.keys(i).some(e=>"status"!==e))return o.Z.json({error:"Cannot edit sent campaigns"},{status:400});let{data:d,error:m}=await n.from("campaigns").update({...i,updated_at:new Date().toISOString()}).eq("id",t).select().single();if(m)return console.error("Error updating campaign:",m),o.Z.json({error:"Failed to update campaign"},{status:500});return o.Z.json({campaign:d})}catch(e){return console.error("Error in PATCH /api/campaigns/[id]:",e),o.Z.json({error:"Internal server error"},{status:500})}}async function g(e,{params:r}){try{let{id:e}=r;if(!e)return o.Z.json({error:"Campaign ID is required"},{status:400});let t=(0,c.l)(),{data:s,error:a}=await t.from("campaigns").select("id, status").eq("id",e).single();if(a||!s)return o.Z.json({error:"Campaign not found"},{status:404});if("sent"===s.status)return o.Z.json({error:"Cannot delete sent campaigns"},{status:400});let{error:i}=await t.from("campaigns").delete().eq("id",e);if(i)return console.error("Error deleting campaign:",i),o.Z.json({error:"Failed to delete campaign"},{status:500});return o.Z.json({success:!0})}catch(e){return console.error("Error in DELETE /api/campaigns/[id]:",e),o.Z.json({error:"Internal server error"},{status:500})}}let f=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/campaigns/[id]/route",pathname:"/api/campaigns/[id]",filename:"route",bundlePath:"app/api/campaigns/[id]/route"},resolvedPagePath:"/Users/marius/Documents/Projects/NewselletOf-the -future/app/api/campaigns/[id]/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:E,serverHooks:q,headerHooks:y,staticGenerationBailout:v}=f,w="/api/campaigns/[id]/route";function x(){return(0,n.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:E})}},3658:(e,r,t)=>{"use strict";t.d(r,{gN:()=>c,vr:()=>l});var s=t(3666),a=t(8638),i=t(1664);let n=new s.W({region:process.env.AWS_REGION,credentials:{accessKeyId:process.env.AWS_ACCESS_KEY_ID,secretAccessKey:process.env.AWS_SECRET_ACCESS_KEY}});async function o(e){try{let r={Source:e.fromName?`${e.fromName} <${e.fromEmail}>`:e.fromEmail,Destination:{ToAddresses:[e.to]},Message:{Subject:{Data:e.subject,Charset:"UTF-8"},Body:{Html:{Data:e.htmlBody,Charset:"UTF-8"},Text:e.textBody?{Data:e.textBody,Charset:"UTF-8"}:void 0}}},t=new a.K(r);return{messageId:(await n.send(t)).MessageId,success:!0}}catch(e){return console.error("Error sending email:",e),{messageId:void 0,success:!1,error:e instanceof Error?e.message:"Unknown error"}}}async function c(e,r,t){(0,i.l)();let s=0,a=0;for(let i=0;i<e.length;i++){let n=e[i];try{let e=await o(n);e.success?(s++,await u(r,n.to,"sent",{messageId:e.messageId,timestamp:new Date().toISOString()})):(a++,await u(r,n.to,"bounced",{error:e.error,timestamp:new Date().toISOString()}))}catch(e){a++,console.error(`Failed to send email to ${n.to}:`,e),await u(r,n.to,"bounced",{error:e instanceof Error?e.message:"Unknown error",timestamp:new Date().toISOString()})}t&&t(s+a,e.length),i<e.length-1&&await new Promise(e=>setTimeout(e,83.33333333333333))}return{successful:s,failed:a}}async function u(e,r,t,s){try{let a=(0,i.l)(),{data:n}=await a.from("campaigns").select("email_list_id").eq("id",e).single();if(!n){console.error("Campaign not found:",e);return}let{data:o}=await a.from("subscribers").select("id").eq("email",r).eq("email_list_id",n.email_list_id).single();if(!o){console.error("Subscriber not found:",r);return}let{error:c}=await a.from("campaign_analytics").insert({campaign_id:e,subscriber_id:o.id,event_type:t,event_data:s});c&&console.error("Error logging email event:",c)}catch(e){console.error("Error logging email event:",e)}}async function l(e){try{let r=(0,i.l)(),{data:t,error:s}=await r.from("campaign_analytics").select("event_type").eq("campaign_id",e);if(s)return console.error("Error fetching campaign analytics:",s),null;let a=t.reduce((e,r)=>(e[r.event_type]=(e[r.event_type]||0)+1,e),{});return{sent:a.sent||0,delivered:a.delivered||0,bounced:a.bounced||0,complaints:a.complaint||0,opened:a.opened||0,clicked:a.clicked||0}}catch(e){return console.error("Error getting campaign analytics:",e),null}}},1664:(e,r,t)=>{"use strict";t.d(r,{l:()=>a});var s=t(1971);let a=()=>(0,s.eI)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY)}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[638,249,974,256],()=>t(7424));module.exports=s})();